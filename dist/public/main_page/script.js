const e="https://futar.bkk.hu/api/query/v1/ws/otp/api/where/",t="/api/hotsmokin",o="BUS",n="TRAM",s="SUBWAY",r="TROLLEYBUS",l="RAIL",a="FERRY";let i=0,d=0,c=10,m=0,u=0,p=m,g=!0,y=!1,h=0,b=0,f=!1,k=0,w=0,E=o;function v(){let e=document.getElementById("pick-line-text"),t=document.getElementsByClassName("hot-smoke-menu")[0],o=document.getElementsByClassName("hot-smoke");t.addEventListener("click",()=>{for(const e of document.querySelectorAll(".hotsmokin-arrow"))e.innerHTML=9660===e.innerHTML.charCodeAt(0)?"&#9650":"&#9660";for(let e=0;e<o.length;e++)o[e].classList.toggle("hot-smoke-active")}),e.addEventListener("keyup",e=>{13==e.keyCode&&F()}),C(),setInterval(C,1e4)}async function T(){if(!y)return;let e="/api/users/"+getUsername()+"/watchlist",t={line:{id:i.id,name:i.shortName},stop1:{id:h.id,name:h.name},stop2:{id:b.id,name:b.name}};fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(async e=>({json:await e.json(),status:e.status})).then(e=>{"success"===e.json.status?j():"fail"===e.json.status?401===e.status?window.location.replace("/"):console.debug("Failed to add segment to user watchlist"):alert("Ismeretlen hiba történt, kérjük probálkozzon újra később.")}).catch(e=>{console.debug(e),alert("Ismeretlen hiba történt, kérjük probálkozzon újra később.")})}async function x(){if(!y)return;let e="/api/users/"+getUsername()+"/watchlist",t={lineId:i.id,stop1Id:h.id,stop2Id:b.id};fetch(e,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(async e=>({json:await e.json(),status:e.status})).then(e=>{"success"===e.json.status?j():"fail"===e.json.status?401===e.status?window.location.replace("/"):console.debug("Failed to remove segment from user watchlist"):alert("Ismeretlen hiba történt, kérjük probálkozzon újra később.")}).catch(e=>{console.debug(e),alert("Ismeretlen hiba történt, kérjük probálkozzon újra később.")})}async function j(){let e=document.querySelector("#wl-btn");if(e)if(y){let t="/api/users/"+getUsername()+"/watchlist",o=null;if(await fetch(t).then(async e=>({json:await e.json(),status:e.status})).then(e=>{"success"===e.json.status?o=e.json.data:401===e.status?window.location.replace("/"):o=null}).catch(e=>{o=null}),null==o)return e.innerText="Hiba",void console.debug("An error occured while loading user watchlist.");let n=!1;for(let e=0;e<o.length;e++)if(o[e].line.id==i.id&&o[e].stop1.id==h.id&&o[e].stop2.id==b.id){n=!0;break}n?(e.setAttribute("class","wl-btn-remove"),e.setAttribute("onclick","watchlist_remove()"),e.innerText="Listából törlés"):(e.setAttribute("class","wl-btn-add"),e.setAttribute("onclick","watchlist_add()"),e.innerText="Listához adás")}else e.setAttribute("class","wl-btn-none"),e.setAttribute("onclick",""),e.innerText="Nincs szakasz"}function I(){let e=document.getElementsByClassName("stopSign-img");switch(E){case o:document.documentElement.style.setProperty("--color-box","var(--color-bus)"),document.documentElement.style.setProperty("--color-box-transparent","var(--color-bus-transparent)"),document.documentElement.style.setProperty("--color-main","white"),document.documentElement.style.setProperty("--color-text","black"),document.documentElement.style.setProperty("--color-navText","white"),document.documentElement.style.setProperty("--background-url",'url("assets/images/bg-bus.png")'),document.documentElement.style.setProperty("--background-positioning-desktop","0px 0px"),document.documentElement.style.setProperty("--background-positioning-mobile","-700px 0px"),e[0].src=e[1].src="assets/images/icon-bus.svg";break;case n:document.documentElement.style.setProperty("--color-box","var(--color-tram)"),document.documentElement.style.setProperty("--color-box-transparent","var(--color-tram-transparent)"),document.documentElement.style.setProperty("--color-main","white"),document.documentElement.style.setProperty("--color-text","black"),document.documentElement.style.setProperty("--color-navText","black"),document.documentElement.style.setProperty("--background-url",'url("assets/images/bg-tram.png")'),document.documentElement.style.setProperty("--background-positioning-desktop","0px 0px"),document.documentElement.style.setProperty("--background-positioning-mobile","-640px 0px"),e[0].src=e[1].src="assets/images/icon-tram.svg";break;case s:document.documentElement.style.setProperty("--color-box","var(--color-metro)"),document.documentElement.style.setProperty("--color-box-transparent","var(--color-metro-transparent)"),document.documentElement.style.setProperty("--color-main","white"),document.documentElement.style.setProperty("--color-text","black"),document.documentElement.style.setProperty("--color-navText","white"),document.documentElement.style.setProperty("--background-url",'url("assets/images/bg-metro.png")'),document.documentElement.style.setProperty("--background-positioning-desktop","0px 0px"),document.documentElement.style.setProperty("--background-positioning-mobile","-300px 0px"),e[0].src=e[1].src="assets/images/icon-metro.svg";break;case r:document.documentElement.style.setProperty("--color-box","var(--color-trolley)"),document.documentElement.style.setProperty("--color-box-transparent","var(--color-trolley-transparent)"),document.documentElement.style.setProperty("--color-main","white"),document.documentElement.style.setProperty("--color-text","black"),document.documentElement.style.setProperty("--color-navText","white"),document.documentElement.style.setProperty("--background-url",'url("assets/images/bg-trolley.png")'),document.documentElement.style.setProperty("--background-positioning-desktop","0px 0px"),document.documentElement.style.setProperty("--background-positioning-mobile","-500px 0px"),e[0].src=e[1].src="assets/images/icon-trolley.svg";break;case l:document.documentElement.style.setProperty("--color-box","var(--color-hev)"),document.documentElement.style.setProperty("--color-box-transparent","var(--color-hev-transparent)"),document.documentElement.style.setProperty("--color-main","white"),document.documentElement.style.setProperty("--color-text","black"),document.documentElement.style.setProperty("--color-navText","white"),document.documentElement.style.setProperty("--background-url",'url("assets/images/bg-hev.png")'),document.documentElement.style.setProperty("--background-positioning-desktop","200px 200px"),document.documentElement.style.setProperty("--background-positioning-mobile","-400px 0px"),e[0].src=e[1].src="assets/images/icon-hev.svg";break;case a:document.documentElement.style.setProperty("--color-box","var(--color-ship)"),document.documentElement.style.setProperty("--color-box-transparent","var(--color-ship-transparent)"),document.documentElement.style.setProperty("--color-main","white"),document.documentElement.style.setProperty("--color-text","black"),document.documentElement.style.setProperty("--color-navText","black"),document.documentElement.style.setProperty("--background-url",'url("assets/images/bg-ship.png")'),document.documentElement.style.setProperty("--background-positioning-desktop","0px 0px"),document.documentElement.style.setProperty("--background-positioning-mobile","-300px 200px"),e[0].src=e[1].src="assets/images/icon-ship.svg"}}async function P(e,t,o){q(),i=e,i.shortName=e.name,document.getElementById("pick-line-text").value=i.shortName,await U();let n=!1,s=!1;for(let e=0;e<m.stops.length;e++)m.stops[e].id===t.id&&(n=!0),m.stops[e].id===o.id&&(s=!0);p=n&&s?m:u,document.getElementById("dropdown-heading").value=p.name,$();for(let e=0;e<p.stops.length;e++)p.stops[e].id==t.id?h=p.stops[e]:p.stops[e].id==o.id&&(b=p.stops[e]);d=p.stops,f=!1,k=0;for(let e=0;e<d.length;e++)if(d[e].id==b.id){f=!1,k=0,e==d.length-1&&(f=!0,k=d[e-1]);break}document.getElementById("dropdown-vehicleType").value=h.type,E=h.type,I();let r=document.getElementById("dropdown-stop1"),l=document.getElementById("dropdown-stop2");if(r.value=h.code,l.value=b.code,1==N()){H(),S(await A()),y=!0,j()}else y=!1,j()}function L(e){w[e-1]&&P(w[e-1].line,w[e-1].stop1,w[e-1].stop2)}async function B(){let e=document.querySelector("#dropdown-time");if(c=Number(e.options[e.selectedIndex].value),0!==p&&y){document.getElementById("result").innerHTML="Számolás...",S(await A())}}function H(){let e={line:{id:i.id,name:i.shortName},stop1:{id:h.id,name:h.name},stop2:{id:b.id,name:b.name}};fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(async e=>({json:await e.json(),status:e.status})).then(e=>{"success"===e.json.status?console.debug("Sent data for hotsmokin statistics"):"fail"===e.json.status?(e.json.data.line&&console.debug(e.json.data.line),e.json.data.stop1&&console.debug(e.json.data.stop1),e.json.data.stop2&&console.debug(e.json.data.stop2)):(console.debug("A server error occured while sending statistics for hotsmokin"),console.debug(e.message))}).catch(e=>{console.debug("A server error occured while sending statistics for hotsmokin"),console.debug(e)})}async function M(){await fetch(t).then(async e=>({json:await e.json(),status:e.status})).then(e=>{if("success"===e.json.status){for(let t=0;t<4;t++){const o=document.querySelector("#hot-smoke-"+(t+1));e.json.data[t]?(o.innerText=`${e.json.data[t].line.name}: ${e.json.data[t].stop1.name} - ${e.json.data[t].stop2.name}`,o.title=`${e.json.data[t].line.name}: ${e.json.data[t].stop1.name} - ${e.json.data[t].stop2.name}`):(o.innerText="Nincs elég adat az információ megjelenítéséhez",o.title="Nincs elég adat az információ megjelenítéséhez")}w=e.json.data}else{console.debug("An error occured while downloading hot smokin' data"),e.json.message&&console.debug(e.json.message);for(let e=0;e<4;e++){const t=document.getElementById("hot-smoke-"+(e+1));t.innerText="Hiba történt a betöltés során",t.title="Hiba történt a betöltés során"}w=0}}).catch(e=>{console.debug("An error occured while downloading hot smokin' data"),console.debug(e);for(let e=0;e<4;e++){const t=document.getElementById("hot-smoke-"+(e+1));t.innerText="Hiba történt a betöltés során",t.title="Hiba történt a betöltés során"}w=0})}function N(){if(0==h||0==b)return 0==m||0==u?(document.getElementById("result").innerHTML="Nincs járat!",0):(document.getElementById("result").innerHTML="Nincsenek kiválasztva megállók!",0);if(h.id==b.id)return document.getElementById("result").innerHTML="Egyeznek a megállók!",0;let e=p.stops,t=!1;for(let o=0;o<e.length;o++){if(e[o].id==h.id){t=!0;break}if(e[o].id==b.id)break}return 0==t?(document.getElementById("result").innerHTML="Rossz sorrend!",0):(document.getElementById("result").innerHTML="Számolás...",1)}window.addEventListener?window.addEventListener("load",v):window.attachEvent&&window.attachEvent("onload",v);class z{time1=0;normalTime1=0;time2=0;normalTime2=0;setOnlyTime1(e){this.time1=e,this.normalTime1=e}setTime1(e,t){this.time1=e,this.normalTime1=t}setOnlyTime2(e){this.time2=e,this.normalTime2=e}setTime2(e,t){this.time2=e,this.normalTime2=t}getTravelTime(){let e=new Date(1e3*this.time1);return(new Date(1e3*this.time2).getTime()-e.getTime())/1e3/60}getLatency(){let e=new Date(1e3*this.time1),t=new Date(1e3*this.normalTime1),o=new Date(1e3*this.time2),n=new Date(1e3*this.normalTime2),s=e.getTime()-t.getTime();return(o.getTime()-n.getTime()-s)/1e3/60}}async function A(){let t=0,o=[],n=0;n=f?k.id:b.id,await fetchJsonp(`${e}arrivals-and-departures-for-stop.json?stopId=${n}&minutesBefore=${c}&minutesAfter=0&includeReferences=false`).then(e=>e.json()).then(e=>{t=e.data.entry.stopTimes}).catch(e=>{console.debug("An error occured while downloading stopTimes for "+n),console.debug(e)});for(let n=0;n<t.length;n++){let s=0;f?s=new z:null==t[n].predictedArrivalTime?(s=new z,s.setOnlyTime2(t[n].arrivalTime),console.debug("Set stop2 time of a trip based on:"),console.debug(t[n])):(s=new z,s.setTime2(t[n].predictedArrivalTime,t[n].arrivalTime),console.debug("Set stop2 time of a trip based on:"),console.debug(t[n])),o.push(s),await fetchJsonp(`${e}trip-details.json?tripId=${t[n].tripId}&includeReferences=false`).then(e=>e.json()).then(e=>{let t=e.data.entry.stopTimes;for(let e=0;e<t.length;e++)if(t[e].stopId==h.id){null==t[e].predictedDepartureTime?(s.setOnlyTime1(t[e].departureTime),console.debug("Set stop1 time of a trip based on:"),console.debug(t[e])):(s.setTime1(t[e].predictedDepartureTime,t[e].departureTime),console.debug("Set stop1 time of a trip based on:"),console.debug(t[e]));break}if(f){let e=t[t.length-1];null==e.predictedArrivalTime?s.setOnlyTime2(e.arrivalTime):s.setTime2(e.predictedArrivalTime,e.arrivalTime)}}).catch(e=>{console.debug("An error occured while trying to get trip details for "+t[n]),console.debug(e)})}return o}function S(e){let t=[];for(let o=0;o<e.length;o++)0!=e[o].time1&&0!=e[o].time2&&null!=e[o].time1&&null!=e[o].time2&&t.push(e[o]);let o=0,n=0;for(let e=0;e<t.length;e++)o+=t[e].getTravelTime(),n+=t[e].getLatency();let s=Math.round(o/t.length*10)/10,r=Math.round(n/t.length*10)/10;isNaN(s)||isNaN(r)?(0==t.length?document.getElementById("result").innerHTML="Nincs adat!":document.getElementById("result").innerHTML="hiba történt!",console.debug("An error occured, avg travel time or avg latency came out to be NaN. Trips used for calculations:"),console.debug(t),console.debug("All downloaded trips:"),console.debug(e)):(document.getElementById("result").innerHTML=s+" perc",console.debug("Calculation successfull, avg travel time: "+s+", avg gained latency: "+r+". Trips used:"),console.debug(t))}async function C(){if(g&&M(),y){S(await A())}}function $(){J();let e=document.getElementById("dropdown-stop1"),t=document.getElementById("dropdown-stop2"),o=p.stops;for(let n in o){let s=document.createElement("option"),r=document.createElement("option");s.value=o[n].code,r.value=o[n].code,s.innerHTML=o[n].name,r.innerHTML=o[n].name,e.appendChild(s),t.appendChild(r)}O()}class K{constructor(e,t){this.name=e,this.stops=t,this.loadRealStops()}loadRealStops(){let e=this.stops,t=[];for(let o=0;o<e.length;o++){let n=e[o];for(let e in d)if(d[e].id==n){t.push(d[e]);break}}this.stops=t}}async function O(){let e=document.getElementById("dropdown-stop1"),t=document.getElementById("dropdown-stop2"),o=e.options[e.selectedIndex].text,n=t.options[t.selectedIndex].text,s=p.stops;for(let e=0;e<s.length;e++)if(s[e].name==o){h=s[e];break}for(let e=0;e<s.length;e++)if(s[e].name==n){b=s[e],f=!1,k=0,e==s.length-1&&(f=!0,k=s[e-1]);break}if(1==N()){H(),S(await A()),y=!0,j()}else y=!1,j()}function D(){let e=document.getElementById("dropdown-heading"),t=e.options[e.selectedIndex].text;p=t==m.name?m:u,$()}function R(){m=new K(variants[0].headsign,variants[0].stopIds),u=new K(variants[1].headsign,variants[1].stopIds);let e=document.getElementById("dropdown-heading");e.innerHTML='<option value="" disabled="" selected="" hidden="">Irány</option>';let t=document.createElement("option");t.innerHTML=m.name,t.value=m.name,e.appendChild(t);let o=document.createElement("option");o.innerHTML=u.name,o.value=u.name,e.appendChild(o),D()}function q(){d=0,p=0,m=0,u=0,document.getElementById("dropdown-heading").innerHTML='<option value="" disabled="" selected="" hidden="">Kérjük válasszon egy járatot</option>',J()}function J(){let e=document.getElementById("dropdown-stop1"),t=document.getElementById("dropdown-stop2");0!=p?(e.innerHTML='<option value="" disabled="" selected="" hidden="">Első megálló</option>',t.innerHTML='<option value="" disabled="" selected="" hidden="">Második megálló</option>'):(e.innerHTML='<option value="" disabled="" selected="" hidden="">Kérjük válasszon egy járatot</option>',t.innerHTML='<option value="" disabled="" selected="" hidden="">Kérjük válasszon egy járatot</option>'),h=0,b=0,y=!1,j(),N()}async function U(){await fetchJsonp(`${e}route-details.json?routeId=${i.id}`).then(e=>e.json()).then(e=>{if("OK"!==e.status)return console.debug("Request succeeded but stop loading failed."),void q();d=e.data.references.stops,variants=e.data.entry.variants,R()}).catch(e=>{console.debug("Error while loading stops"),console.debug(e)})}async function F(){let t=document.getElementById("pick-line-text").value,o=document.getElementById("dropdown-vehicleType"),n=o.options[o.selectedIndex].value;""!=t?(q(),await fetchJsonp(`${e}search.json?query=${t}`).then(e=>e.json()).then(e=>{i=e.data.references.routes;let o=!1;for(let e in i)if(i[e].shortName.toLowerCase()==t.toLowerCase()&&i[e].type.toLowerCase()==n.toLowerCase()){console.debug("Found a route with matching name"),i=i[e],o=!0;break}if(!o)for(let e in i)if(i[e].type.toLowerCase()==n.toLowerCase()){console.debug("Found a route based on the input"),i=i[e],o=!0;break}(new Date).getDay();if("BKK_3031"==i.id&&(i.id="BKK_3030",i.description="Mexikói út M | Gubacsi út / Határ út"),!i.id||"BKK_9999"==i.id)return alert("Nem találtunk járatot"),console.debug("No search results based on text '"+t.toLowerCase()+"'"),void(i=0);console.debug("Loading line stops and variants"),E=n,I(),U()}).catch(e=>{alert("Hiba történt a járat keresése során. Kérjük próbálkozzon újra később."),console.debug(e)}),document.getElementById("pick-line-text").value=0==i?"":i.shortName):alert("Kérjük válasszon járatot")}