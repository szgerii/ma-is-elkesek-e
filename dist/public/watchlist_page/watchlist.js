const e="https://futar.bkk.hu/api/query/v1/ws/otp/api/where/";let t=null;const n="BUS",i="TRAM",l="SUBWAY",s="TROLLEYBUS",o="RAIL",r="FERRY";let c=0,a=0,d=0,h=0,m=d,p=0,u=!1;function g(){t=getUsername(),k()}function w(e){let n="/api/users/"+t+"/watchlist",i={lineId:p[e].line.id,stop1Id:p[e].stop1.id,stop2Id:p[e].stop2.id};fetch(n,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).then(t=>{if(401===t.status)window.location.replace("/");else if(2!==Math.floor(t.status/100))return alert("Hiba történt a szakasz eltávolítása során. Kérjük próbálkozzon újra később."),console.debug("An error occured while deleting a section"),void console.debug(t);const n=document.querySelector(".content");for(let t=e;t<p.length-1;t++)p[t]=p[t+1],p[t].orderIndex--,n.children[t+1].children[2].children[0].onclick=()=>T(t),n.children[t+1].children[2].children[1].onclick=()=>v(t),n.children[t+1].children[2].children[2].onclick=()=>w(t);n.children[e].remove(),p.pop(),0===p.length&&k(!0)})}async function f(){let e="/api/users/"+t+"/watchlist",n=null;return await fetch(e).then(async e=>({json:await e.json(),status:e.status})).then(e=>{401===e.status?window.location.replace("/"):"success"!==e.json.status&&(alert("Hiba történt a járatlista betöltése során. Kérjük próbálkozzon újra később."),n=null),n=e.json.data}).catch(e=>{alert("Hiba történt a lista betöltése során. Kérjük próbálkozzon újra később."),console.debug("An error occured while loading the user's watchlist"),console.debug(e)}),n}async function b(t){let n="";switch(await fetchJsonp(`${e}route-details.json?routeId=${t.id}`).then(e=>e.json()).then(e=>{"OK"==e.status&&(n=e.data.entry.type)}).catch(e=>{console.debug("An error occured while download the type of the following line: "+t),console.debug(e)}),n){case"BUS":n="bus";break;case"TRAM":n="tram";break;case"SUBWAY":n="metro";break;case"FERRY":n="ship";break;case"RAIL":n="hev";break;case"TROLLEYBUS":n="trolley"}return n}async function k(e){if(u)return;u=!0,e||(p=await f());const t=document.querySelector(".content");if(0===p.length){const e=document.createElement("div");e.id="info-container";const n=document.createElement("p");return n.id="empty-info",n.innerText="Még nincsenek szakaszok a listádon. Új szakaszokat a főoldalról menthetsz el, egy útvonal kiválasztása után.",e.appendChild(n),t.appendChild(e),void(u=!1)}p.sort((e,t)=>e.orderIndex<t.orderIndex?-1:e.orderIndex>t.orderIndex?1:0);for(let e=t.children.length-1;e>=0;e--)t.children[e].remove();for(let e=0;e<p.length;e++){const n=await b(p[e].line),i=document.createElement("div");i.classList.add("watchlist-element"),i.classList.add("watchlist-"+n);const l=document.createElement("img");l.classList.add("watchlist-image"),l.setAttribute("src","assets/images/icon-"+n+".svg");const s=document.createElement("div");s.classList.add("watchlist-text"),s.innerHTML="["+p[e].line.name+"] "+p[e].stop1.name+" - "+p[e].stop2.name+": ? perc";const o=document.createElement("div");o.classList.add("button-container");const r=document.createElement("img");r.src=`/assets/images/triangle-${"tram"===n||"ship"===n?"black":"white"}.png`,r.classList.add("watchlist-move"),r.onclick=()=>T(e),o.appendChild(r);const c=document.createElement("img");c.src=`/assets/images/triangle-${"tram"===n||"ship"===n?"black":"white"}.png`,c.classList.add("watchlist-move"),c.classList.add("watchlist-move-down"),c.onclick=()=>v(e),o.appendChild(c);const a=document.createElement("img");a.src=`/assets/images/x-${"tram"===n||"ship"===n?"black":"white"}.png`,a.classList.add("watchlist-delete"),a.setAttribute("onclick","deleteSegment("+e+");"),o.appendChild(a),i.appendChild(l),i.appendChild(s),i.appendChild(o),t.appendChild(i)}y(p),setInterval(()=>y(p),1e4),u=!1}function T(e){0!==p[e].orderIndex&&fetch(`/api/users/${t}/watchlist`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({lineId:p[e].line.id,stop1Id:p[e].stop1.id,stop2Id:p[e].stop2.id,moveUp:!0})}).then(()=>{const t=document.querySelector(".content");p[e].orderIndex--,p[e-1].orderIndex++;let n=p[e];p[e]=p[e-1],p[e-1]=n,n=t.children[e].cloneNode(!0),t.children[e].replaceWith(t.children[e-1].cloneNode(!0)),t.children[e-1].replaceWith(n),t.children[e].children[2].children[0].onclick=()=>T(e),t.children[e].children[2].children[1].onclick=()=>v(e),t.children[e].children[2].children[2].onclick=()=>w(e),t.children[e-1].children[2].children[0].onclick=()=>T(e-1),t.children[e-1].children[2].children[1].onclick=()=>v(e-1),t.children[e-1].children[2].children[2].onclick=()=>w(e-1)}).catch(e=>{console.debug("An error occured while moving a section"),console.debug(e),alert("Ismeretlen hiba történt a szakasz léptetése során, kérjük próbálkozzon újra később")})}function v(e){p[e].orderIndex!==p.length-1&&fetch(`/api/users/${t}/watchlist`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({lineId:p[e].line.id,stop1Id:p[e].stop1.id,stop2Id:p[e].stop2.id,moveUp:!1})}).then(()=>{const t=document.querySelector(".content");p[e].orderIndex++,p[e+1].orderIndex--;let n=p[e];p[e]=p[e+1],p[e+1]=n,n=t.children[e].cloneNode(!0),t.children[e].replaceWith(t.children[e+1].cloneNode(!0)),t.children[e+1].replaceWith(n),t.children[e].children[2].children[0].onclick=()=>T(e),t.children[e].children[2].children[1].onclick=()=>v(e),t.children[e].children[2].children[2].onclick=()=>w(e),t.children[e+1].children[2].children[0].onclick=()=>T(e+1),t.children[e+1].children[2].children[1].onclick=()=>v(e+1),t.children[e+1].children[2].children[2].onclick=()=>w(e+1)}).catch(e=>{console.debug("An error occured while moving a section"),console.debug(e),alert("Ismeretlen hiba történt a szakasz léptetése során, kérjük próbálkozzon újra később")})}function y(e){const t=document.querySelector(".content");for(let n=0;n<t.children.length;n++)j(e[n].line,e[n].stop1,e[n].stop2,t.children[n].children[1])}function I(e){let t=[];for(let n=0;n<e.length;n++)0!=e[n].time1&&0!=e[n].time2&&null!=e[n].time1&&null!=e[n].time2&&t.push(e[n]);let n=0,i=0;for(let e=0;e<t.length;e++)n+=t[e].getTravelTime(),i+=t[e].getLatency();let l=Math.round(n/t.length*10)/10,s=Math.round(i/t.length*10)/10;return isNaN(l)||isNaN(s)?(console.debug("An error occured, avg travel time or avg latency came out to be NaN. Trips used for calculations:"),console.debug(t),console.debug("All downloaded trips:"),console.debug(e),null):l}async function j(t,n,i,l){let s=t;s.shortName=t.name;let o=0,r=0,c=0,a=0;if(await fetchJsonp(`${e}route-details.json?routeId=${s.id}`).then(e=>e.json()).then(e=>{"OK"===e.status&&(o=e.data.references.stops,r=e.data.entry.variants)}).catch(e=>{console.debug(`An error occured while loading the following segment: ${t}: ${n} - ${i}`),console.debug(e)}),0===o||0===r)return;let d=new L(r[0].headsign,r[0].stopIds,o),h=new L(r[1].headsign,r[1].stopIds,o),m=d,p=!1,u=!1;for(let e=0;e<d.stops.length;e++)d.stops[e].id===n.id&&(p=!0),d.stops[e].id===i.id&&(u=!0);m=p&&u?d:h;for(let e=0;e<m.stops.length;e++)m.stops[e].id==n.id?c=m.stops[e]:m.stops[e].id==i.id&&(a=m.stops[e]);o=m.stops;let g=!1,w=0;for(let e=0;e<o.length;e++)if(o[e].id==a.id){g=!1,w=0,e==o.length-1&&(g=!0,w=o[e-1]);break}let f=I(await z(s,o,c,a,g,w,20));l.innerHTML=null==f?"["+s.shortName+"] "+c.name+" - "+a.name+": nincs adat":"["+s.shortName+"] "+c.name+" - "+a.name+": "+f+" perc"}window.addEventListener?window.addEventListener("load",g):window.attachEvent&&window.attachEvent("onload",g);class A{time1=0;normalTime1=0;time2=0;normalTime2=0;setOnlyTime1(e){this.time1=e,this.normalTime1=e}setTime1(e,t){this.time1=e,this.normalTime1=t}setOnlyTime2(e){this.time2=e,this.normalTime2=e}setTime2(e,t){this.time2=e,this.normalTime2=t}getTravelTime(){let e=new Date(1e3*this.time1);return(new Date(1e3*this.time2).getTime()-e.getTime())/1e3/60}getLatency(){let e=new Date(1e3*this.time1),t=new Date(1e3*this.normalTime1),n=new Date(1e3*this.time2),i=new Date(1e3*this.normalTime2),l=e.getTime()-t.getTime();return(n.getTime()-i.getTime()-l)/1e3/60}}async function z(t,n,i,l,s,o,r){let c=0,a=[],d=0;d=s?o.id:l.id,await fetchJsonp(`${e}arrivals-and-departures-for-stop.json?stopId=${d}&minutesBefore=${r}&minutesAfter=0&includeReferences=false`).then(e=>e.json()).then(e=>{c=e.data.entry.stopTimes}).catch(e=>{console.debug("An error occured while downloading stopTimes for "+d),console.debug(e)});for(let t=0;t<c.length;t++){let n=0;s?n=new A:null==c[t].predictedArrivalTime?(n=new A,n.setOnlyTime2(c[t].arrivalTime)):(n=new A,n.setTime2(c[t].predictedArrivalTime,c[t].arrivalTime)),a.push(n),await fetchJsonp(`${e}trip-details.json?tripId=${c[t].tripId}&includeReferences=false`).then(e=>e.json()).then(e=>{let t=e.data.entry.stopTimes;for(let e=0;e<t.length;e++)if(t[e].stopId==i.id){null==t[e].predictedDepartureTime?n.setOnlyTime1(t[e].departureTime):n.setTime1(t[e].predictedDepartureTime,t[e].departureTime);break}if(s){let e=t[t.length-1];null==e.predictedArrivalTime?n.setOnlyTime2(e.arrivalTime):n.setTime2(e.predictedArrivalTime,e.arrivalTime)}}).catch(e=>{console.debug("An error occured while trying to get trip details for "+c[t]),console.debug(e)})}return a}class L{constructor(e,t,n){this.name=e,this.stops=t,this.allStops=n,this.loadRealStops()}loadRealStops(){let e=this.stops,t=[];for(let n=0;n<e.length;n++){let i=e[n];for(let e in this.allStops)if(this.allStops[e].id==i){t.push(this.allStops[e]);break}}this.stops=t}}